<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スケジュール管理</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <div class="top-left-button">
        <button class="back-button" onclick="location.href='index.html'">戻る</button>
    </div>

    <h1>スケジュール管理</h1>

    <div class="card" style="min-height: 500px;">
      <div class="tab-container">
        <button class="tab-button active" onclick="openTab(event, 'ScheduleList')">スケジュール一覧</button>
        <button class="tab-button" onclick="openTab(event, 'History')">実行履歴</button>
      </div>

      <div id="ScheduleList" class="tab-content" style="display: block;">
        <table class="manage-table">
          <thead>
            <tr>
              <th style="width: 25%;">スケジュール名</th>
              <th style="width: 20%;">次回実行</th>
              <th style="width: 40%;">実行タイミング</th>
              <th style="width: 15%;">操作</th>
            </tr>
          </thead>
          <tbody id="scheduleTableBody"></tbody>
        </table>
        <div id="scheduleNoData" style="padding:20px; color:#999; display:none;">スケジュールがありません</div>
      </div>

      <div id="History" class="tab-content" style="display: none;">
        <table class="manage-table">
          <thead>
            <tr>
              <th style="width: 20%;">実行日時</th>
              <th style="width: 25%;">スケジュール名</th>
              <th style="width: 20%;">結果</th>
            </tr>
          </thead>
          <tbody id="historyTableBody"></tbody>
        </table>
        <div id="historyNoData" style="padding:20px; color:#999;">実行履歴はありません</div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      loadSchedules();
    });

    async function loadSchedules() {
      const schedules = await window.api.getSchedules();
      
      // テーブル描画（スケジュール一覧）
      renderTable('scheduleTableBody', 'scheduleNoData', schedules, renderScheduleRow);

      // テーブル描画（実行履歴：今回は空）
      renderTable('historyTableBody', 'historyNoData', [], renderHistoryRow);
    }

    // テーブル描画共通関数
    function renderTable(tbodyId, noDataId, dataList, rowRenderer) {
      const tbody = document.getElementById(tbodyId);
      const noDataMsg = document.getElementById(noDataId);
      
      tbody.innerHTML = ""; 

      if (!dataList || dataList.length === 0) {
        if(noDataMsg) noDataMsg.style.display = "block";
      } else {
        if(noDataMsg) noDataMsg.style.display = "none";
        dataList.forEach(item => {
          tbody.innerHTML += rowRenderer(item);
        });
      }
    }

    // ▼▼▼ 修正箇所：複数タイミングに対応した行生成 ▼▼▼
    function renderScheduleRow(item) {
      let timingText = "";
      
      // 新仕様：配列（timings）の場合
      if (item.timings && Array.isArray(item.timings)) {
        timingText = item.timings.map(t => {
           const typeStr = t.type === 'weekly' ? '週次' : '月次';
           return `<div style="margin-bottom:2px;">${typeStr}(${t.date} ${t.time})</div>`;
        }).join('');
      } 
      // 旧仕様：単一オブジェクト（timing）の場合（互換性のため残す）
      else if (item.timing) {
         const typeStr = item.timing.type === 'weekly' ? '週次' : '月次';
         timingText = `<div>${typeStr}(${item.timing.date} ${item.timing.time})</div>`;
      }

      const nextRun = "計算中..."; // ダミー表示

      return `
        <tr>
          <td>${item.name}</td>
          <td>${nextRun}</td>
          <td style="text-align:left;">${timingText}</td>
          <td>
            <button class="btn-gray btn-delete-row" onclick="deleteItem('${item.id}')">削除</button>
          </td>
        </tr>`;
    }

    // 実行履歴行（ダミー）
    function renderHistoryRow(item) {
      return ``;
    }

    // 削除処理
    async function deleteItem(id) {
      if(confirm("このスケジュールを削除しますか？")) {
        await window.api.deleteSchedule(id);
        loadSchedules(); // リスト再読み込み
      }
    }

    // タブ切り替え
    function openTab(evt, tabName) {
      const tabcontents = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabcontents.length; i++) {
        tabcontents[i].style.display = "none";
      }
      const tablinks = document.getElementsByClassName("tab-button");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
    }
  </script>
</body>
</html>